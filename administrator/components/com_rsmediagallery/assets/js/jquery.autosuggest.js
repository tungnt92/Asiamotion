(function(a){a.fn.autoSuggest=function(b,c){var d={asHtmlID:false,startText:"Enter Name Here",emptyText:"No Results Found",preFill:{},limitText:"No More Selections Are Allowed",selectedItemProp:"value",selectedValuesProp:"value",searchObjProps:"value",queryParam:"q",retrieveLimit:false,extraParams:"",matchCase:false,minChars:1,keyDelay:400,resultsHighlight:true,neverSubmit:false,selectionLimit:false,showResultList:true,start:function(){},selectionClick:function(a){},selectionAdded:function(a){},selectionRemoved:function(a){a.remove()},formatList:false,beforeRetrieve:function(a){return a},retrieveComplete:function(a){return a},resultClick:function(a){},resultsComplete:function(){}};var e=a.extend(d,c);var f="object";var g=0;if(typeof b=="string"){f="string";var h=b}else{var i=b;for(k in b)if(b.hasOwnProperty(k))g++}if(f=="object"&&g>0||f=="string"){return this.each(function(b){function G(b){if(a(":visible",n).length>0){var c=a("li",n);if(b=="down"){var d=c.eq(0)}else{var d=c.filter(":last")}var e=a("li.active:first",n);if(e.length>0){if(b=="down"){d=e.next()}else{d=e.prev()}}c.removeClass("active");d.addClass("active")}}function F(b,c){p.val(p.val()+b[e.selectedValuesProp]+",");var f=a('<li class="as-selection-item" id="as-selection-'+c+'"></li>').click(function(){e.selectionClick.call(this,a(this));l.children().removeClass("selected");a(this).addClass("selected")}).mousedown(function(){j=false});var g=a('<a class="as-close">×</a>').click(function(){values=p.val().split(",");values.pop();new_values=[];for(v=0;v<values.length;v++){if(values[v]==b[e.selectedValuesProp])continue;new_values.push(values[v])}if(new_values.length>0)p.val(new_values.join(",")+",");else p.val("");e.selectionRemoved.call(this,f);j=true;d.focus();return false});m.before(f.html("<strong>"+b[e.selectedItemProp]+"</strong>").prepend(g));e.selectionAdded.call(this,m.prev())}function E(b,c){if(!e.matchCase){c=c.toLowerCase()}var f=0;n.html(o.html("")).hide();for(var h=0;h<g;h++){var i=h;D++;var k=false;if(e.searchObjProps=="value"){var m=b[i].value}else{var m="";var q=e.searchObjProps.split(",");for(var r=0;r<q.length;r++){var s=a.trim(q[r]);m=m+b[i][s]+" "}}if(m){if(!e.matchCase){m=m.toLowerCase()}found=false;values=p.val().split(",");values.pop();for(v=0;v<values.length;v++){if(values[v]==b[i][e.selectedValuesProp]){found=true;break}}if(m.search(c)!=-1&&!found&&p.val().search(","+b[i][e.selectedValuesProp]+",")==-1){k=true}}if(k){var t=a('<li class="as-result-item" id="as-result-item-'+i+'"></li>').click(function(){var b=a(this).data("data");var c=b.num;if(a("#as-selection-"+c,l).length<=0&&!B){var f=b.attributes;d.val("").focus();z="";F(f,c);e.resultClick.call(this,b);n.hide()}B=false}).mousedown(function(){j=false}).mouseover(function(){a("li",o).removeClass("active");a(this).addClass("active")}).data("data",{attributes:b[i],num:D});var u=a.extend({},b[i]);if(!e.matchCase){var w=new RegExp("(?![^&;]+;)(?!<[^<>]*)("+c+")(?![^<>]*>)(?![^&;]+;)","gi")}else{var w=new RegExp("(?![^&;]+;)(?!<[^<>]*)("+c+")(?![^<>]*>)(?![^&;]+;)","g")}if(e.resultsHighlight){u[e.selectedItemProp]=u[e.selectedItemProp].replace(w,"<em>$1</em>")}if(!e.formatList){t=t.html(u[e.selectedItemProp])}else{t=e.formatList.call(this,u,t)}o.append(t);delete u;f++;if(e.retrieveLimit&&e.retrieveLimit==f){break}}}l.removeClass("loading");if(f<=0){o.html('<li class="as-message">'+e.emptyText.replace("%s",c)+"</li>")}o.css("width",l.outerWidth());n.show();e.resultsComplete.call(this)}function C(){if(lastKeyPressCode==46||lastKeyPressCode>8&&lastKeyPressCode<32){return n.hide()}var b=d.val().replace(/[\\]+|[\/]+/g,"");if(b==z)return;z=b;if(b.length>=e.minChars){l.addClass("loading");if(f=="string"){var c="";if(e.retrieveLimit){c="&limit="+encodeURIComponent(e.retrieveLimit)}if(e.beforeRetrieve){b=e.beforeRetrieve.call(this,b)}a.getJSON(h+"?"+e.queryParam+"="+encodeURIComponent(b)+c+e.extraParams,function(a){g=0;var c=e.retrieveComplete.call(this,a);for(k in c)if(c.hasOwnProperty(k))g++;E(c,b)})}else{if(e.beforeRetrieve){b=e.beforeRetrieve.call(this,b)}E(i,b)}}else{l.removeClass("loading");n.hide()}}if(!e.asHtmlID){b=b+""+Math.floor(Math.random()*100);var c="as-input-"+b}else{b=e.asHtmlID;var c=b}e.start.call(this);var d=a(this);e.preFill=d.val();d.attr("autocomplete","off").addClass("as-input").attr("id",c).val(e.startText);var j=false;d.wrap('<ul class="as-selections" id="as-selections-'+b+'"></ul>').wrap('<li class="as-original" id="as-original-'+b+'"></li>');var l=a("#as-selections-"+b);var m=a("#as-original-"+b);var n=a('<div class="as-results" id="as-results-'+b+'"></div>').hide();var o=a('<ul class="as-list"></ul>');var p=a('<input type="hidden" class="as-values" name="'+d.attr("name")+'" id="as-values-'+b+'" />');d.attr("name","as_values_"+b);var q="";if(typeof e.preFill=="string"){var r=e.preFill.split(",");for(var s=0;s<r.length;s++){var t={};t[e.selectedValuesProp]=r[s];if(r[s]!=""){F(t,"000"+s)}}q=e.preFill}else{q="";var u=0;for(k in e.preFill)if(e.preFill.hasOwnProperty(k))u++;if(u>0){for(var s=0;s<u;s++){var w=e.preFill[s][e.selectedValuesProp];if(w==undefined){w=""}q=q+w+",";if(w!=""){F(e.preFill[s],"000"+s)}}}}if(q!=""){d.val("");var x=q.substring(q.length-1);if(x!=","){q=q+","}p.val(q);a("li.as-selection-item",l).addClass("blur").removeClass("selected")}d.after(p);l.click(function(){j=true;d.focus()}).mousedown(function(){j=false}).after(n);var y=null;var z="";var A=0;var B=false;d.focus(function(){if(a(this).val()==e.startText&&p.val()==""){a(this).val("")}else if(j){a("li.as-selection-item",l).removeClass("blur");if(a(this).val()!=""){o.css("width",l.outerWidth());n.show()}}j=true;return true}).blur(function(){if(a(this).val()==""&&p.val()==""&&q==""){a(this).val(e.startText)}else if(j){a("li.as-selection-item",l).addClass("blur").removeClass("selected");n.hide()}}).keydown(function(b){lastKeyPressCode=b.keyCode;first_focus=false;switch(b.keyCode){case 38:b.preventDefault();G("up");break;case 40:b.preventDefault();G("down");break;case 8:if(d.val()==""){var c=p.val().split(",");c=c[c.length-2];l.children().not(m.prev()).removeClass("selected");if(m.prev().hasClass("selected")){values=p.val().split(",");values.pop();new_values=[];for(v=0;v<values.length;v++){if(values[v]==c)continue;new_values.push(values[v])}if(new_values.length>0)p.val(new_values.join(",")+",");else p.val("");e.selectionRemoved.call(this,m.prev())}else{e.selectionClick.call(this,m.prev());m.prev().addClass("selected")}}if(d.val().length==1){n.hide();z=""}if(a(":visible",n).length>0){if(y){clearTimeout(y)}y=setTimeout(function(){C()},e.keyDelay)}break;case 9:case 188:B=true;var f=d.val().replace(/(,)/g,"");if(f!=""&&p.val().search(","+f+",")<0&&f.length>=e.minChars){b.preventDefault();var g={};g[e.selectedItemProp]=f;g[e.selectedValuesProp]=f;var h=a("li",l).length;F(g,"00"+(h+1));d.val("")};case 13:B=false;var i=a("li.active:first",n);if(i.length>0){i.click();n.hide()}if(e.neverSubmit||i.length>0){b.preventDefault()}break;default:if(e.showResultList){if(e.selectionLimit&&a("li.as-selection-item",l).length>=e.selectionLimit){o.html('<li class="as-message">'+e.limitText+"</li>");n.show()}else{if(y){clearTimeout(y)}y=setTimeout(function(){C()},e.keyDelay)}}break}});var D=0})}}})(jQuery)